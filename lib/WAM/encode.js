Object.defineProperty(exports,"__esModule",{value:!0});exports.encodeWAM=void 0;const constants_1=require("./constants"),getHeaderBitLength=d=>256>d?2:3,encodeWAM=d=>{d.buffer=[];encodeWAMHeader(d);encodeEvents(d);console.log(d.buffer);const c=d.buffer.map(b=>b.length).reduce((b,f)=>b+f),e=Buffer.alloc(c);let a=0;d.buffer.forEach(b=>{b.copy(e,a);a+=b.length});return e};exports.encodeWAM=encodeWAM;
function encodeWAMHeader(d){const c=Buffer.alloc(8);c.write("WAM",0,"utf8");c.writeUInt8(d.protocolVersion,3);c.writeUInt8(1,4);c.writeUInt16BE(d.sequence,5);c.writeUInt8(0,7);d.buffer.push(c)}function encodeGlobalAttributes(d,c){for(const [e,a]of Object.entries(c)){c=constants_1.WEB_GLOBALS.find(f=>(null===f||void 0===f?void 0:f.name)===e).id;let b=a;"boolean"===typeof b&&(b=b?1:0);d.buffer.push(serializeData(c,b,constants_1.FLAG_GLOBAL))}}
function encodeEvents(d){for(const [c,{props:e,globals:a}]of d.events.map(b=>Object.entries(b)[0])){encodeGlobalAttributes(d,a);const b=constants_1.WEB_EVENTS.find(g=>g.name===c),f=Object.entries(e);let h=!1;for(const [,g]of f)h||=null!==g;d.buffer.push(serializeData(b.id,-b.weight,h?constants_1.FLAG_EVENT:constants_1.FLAG_EVENT|constants_1.FLAG_EXTENDED));for(let g=0;g<f.length;g++){const [l,m]=f[g],n=b.props[l][0];h=g<f.length-1;let k=m;"boolean"===typeof k&&(k=k?1:0);d.buffer.push(serializeData(n,
k,h?constants_1.FLAG_EVENT:constants_1.FLAG_FIELD|constants_1.FLAG_EXTENDED))}}}
function serializeData(d,c,e){var a=getHeaderBitLength(d);let b=0;if(null===c){if(e===constants_1.FLAG_GLOBAL)return a=Buffer.alloc(a),serializeHeader(a,b,d,e),a}else{if("number"===typeof c&&Number.isInteger(c))return 0===c||1===c?(a=Buffer.alloc(a),serializeHeader(a,b,d,e|c+1<<4)):-128<=c&&128>c?(a=Buffer.alloc(a+1),b=serializeHeader(a,b,d,e|48),a.writeInt8(c,b)):-32768<=c&&32768>c?(a=Buffer.alloc(a+2),b=serializeHeader(a,b,d,e|64),a.writeInt16LE(c,b)):-2147483648<=c&&2147483648>c?(a=Buffer.alloc(a+
4),b=serializeHeader(a,b,d,e|80),a.writeInt32LE(c,b)):(a=Buffer.alloc(a+8),b=serializeHeader(a,b,d,e|112),a.writeDoubleLE(c,b)),a;if("number"===typeof c)return a=Buffer.alloc(a+8),b=serializeHeader(a,b,d,e|112),a.writeDoubleLE(c,b),a;if("string"===typeof c){const f=Buffer.byteLength(c,"utf8");256>f?(a=Buffer.alloc(a+1+f),b=serializeHeader(a,b,d,e|128),a.writeUint8(f,b++)):65536>f?(a=Buffer.alloc(a+2+f),b=serializeHeader(a,b,d,e|144),a.writeUInt16LE(f,b),b+=2):(a=Buffer.alloc(a+4+f),b=serializeHeader(a,
b,d,e|160),a.writeUInt32LE(f,b),b+=4);a.write(c,b,"utf8");return a}}throw"missing";}function serializeHeader(d,c,e,a){256>e?(d.writeUInt8(a,c),c+=1,d.writeUInt8(e,c),c+=1):(d.writeUInt8(a|constants_1.FLAG_BYTE,c),c+=1,d.writeUInt16LE(e,c),c+=2);return c};
