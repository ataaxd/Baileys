var __createBinding=this&&this.__createBinding||(Object.create?function(f,g,d,k){void 0===k&&(k=d);var c=Object.getOwnPropertyDescriptor(g,d);if(!c||("get"in c?!g.__esModule:c.writable||c.configurable))c={enumerable:!0,get:function(){return g[d]}};Object.defineProperty(f,k,c)}:function(f,g,d,k){void 0===k&&(k=d);f[k]=g[d]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(f,g){Object.defineProperty(f,"default",{enumerable:!0,value:g})}:function(f,g){f["default"]=g}),__importStar=
this&&this.__importStar||function(f){if(f&&f.__esModule)return f;var g={};if(null!=f)for(var d in f)"default"!==d&&Object.prototype.hasOwnProperty.call(f,d)&&__createBinding(g,f,d);__setModuleDefault(g,f);return g};Object.defineProperty(exports,"__esModule",{value:!0});exports.encodeBinaryNode=void 0;
const constants=__importStar(require("./constants")),jid_utils_1=require("./jid-utils"),encodeBinaryNode=({tag:f,attrs:g,content:d},k=constants,c=[0])=>{const {TAGS:h,TOKEN_MAP:v}=k,w=(a,b,e=!1)=>{for(let l=0;l<b;l++)c.push(a>>8*(e?l:b-1-l)&255)},n=a=>a.forEach(b=>c.push(b)),q=a=>{if(4294967296<=a)throw Error("string too large to encode: "+a);1048576<=a?(c.push(h.BINARY_32&255),w(a,4)):256<=a?(c.push(h.BINARY_20&255),n([a>>16&15,a>>8&255,a&255])):(c.push(h.BINARY_8&255),c.push(a&255))},x=({domainType:a,
device:b,user:e,server:l})=>{"undefined"!==typeof b?(c.push(h.AD_JID&255),c.push((a||0)&255),c.push((b||0)&255),m(e)):(c.push(h.JID_PAIR&255),e.length?m(e):c.push(h.LIST_EMPTY&255),m(l))},y=a=>{switch(a){case "-":return 10;case ".":return 11;case "\x00":return 15;default:if("0"<=a&&"9">=a)return a.charCodeAt(0)-48;throw Error(`invalid byte for nibble "${a}"`);}},z=a=>{if("0"<=a&&"9">=a)return a.charCodeAt(0)-48;if("A"<=a&&"F">=a)return 10+a.charCodeAt(0)-65;if("a"<=a&&"f">=a)return 10+a.charCodeAt(0)-
97;if("\x00"===a)return 15;throw Error(`Invalid hex char "${a}"`);},r=(a,b)=>{if(a.length>h.PACKED_MAX)throw Error("Too many bytes to pack");c.push(("nibble"===b?h.NIBBLE_8:h.HEX_8)&255);var e=Math.ceil(a.length/2);0!==a.length%2&&(e|=128);c.push(e&255);b="nibble"===b?y:z;e=Math.floor(a.length/2);for(let p=0;p<e;p++){var l=a[2*p+1];l=b(a[2*p])<<4|b(l);c.push(l&255)}0!==a.length%2&&(a=b(a[a.length-1])<<4|b("\x00"),c.push(a&255))},m=a=>{var b=v[a];if(b)"number"===typeof b.dict&&c.push(h.DICTIONARY_0+
b.dict&255),c.push(b.index&255);else{a:if(a.length>h.PACKED_MAX)b=!1;else{for(b=0;b<a.length;b++){var e=a[b];if(!("0"<=e&&"9">=e)&&"-"!==e&&"."!==e){b=!1;break a}}b=!0}if(b)r(a,"nibble");else{a:if(a.length>h.PACKED_MAX)b=!1;else{for(b=0;b<a.length;b++)if(e=a[b],!("0"<=e&&"9">=e||"A"<=e&&"F">=e||"a"<=e&&"f">=e)){b=!1;break a}b=!0}b?r(a,"hex"):a&&((b=(0,jid_utils_1.jidDecode)(a))?x(b):(a=Buffer.from(a,"utf-8"),q(a.length),n(a)))}}},t=a=>{0===a?c.push(h.LIST_EMPTY&255):256>a?n([h.LIST_8,a]):(c.push(h.LIST_16&
255),n([a>>8&255,a&255]))},u=Object.keys(g).filter(a=>"undefined"!==typeof g[a]&&null!==g[a]);t(2*u.length+1+("undefined"!==typeof d?1:0));m(f);for(const a of u)"string"===typeof g[a]&&(m(a),m(g[a]));if("string"===typeof d)m(d);else if(Buffer.isBuffer(d)||d instanceof Uint8Array)q(d.length),n(d);else if(Array.isArray(d)){t(d.length);for(const a of d)(0,exports.encodeBinaryNode)(a,k,c)}else if("undefined"!==typeof d)throw Error(`invalid children for header "${f}": ${d} (${typeof d})`);return Buffer.from(c)};
exports.encodeBinaryNode=encodeBinaryNode;
